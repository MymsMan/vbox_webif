<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- The jQuery library is a prerequisite for all jqSuite products -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- This is the Javascript file of jqGrid -->
  <script type="text/ecmascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/5.5.5/js/jquery.jqGrid.min.js"></script>
  <!-- This is the localization file of the grid controlling messages, labels, etc. -->
  <script type="text/ecmascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/5.5.5/js/i18n/grid.locale-en.min.js"></script>
  <!-- A link to a jQuery UI ThemeRoller theme, more than 22 built-in and many more custom -->
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <!-- The link to the CSS that the grid needs -->
  <link rel="stylesheet" type="text/css" media="screen" href="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/5.5.4/css/ui.jqgrid.min.css" />
  <!-- Add icon library -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <title>Vbox recordings</title>
  <style>
  /* .ui-jqdialog-content .form-view-data { */
  .record-red {
    font-size:12px;
    color:red;
  }
  .ui-tabs-panel {
    font-size:12px;
  }
  .ui-tabs-anchor {
    font-size:14px;
    font-weight: bold;
  }
  .ui-jqgrids-labels .ui-sortable th,
  #v_programme-desc, #v_programme-title, #v_desc, #v_title {
    white-space: normal;
  }
  #rec-dial-tab {
    border-collapse: collapse;
    font-size: 12px;
  }
  #rec-dial-tab tr>:nth-child(1) {
    font-weight: bold;
  }
  #rec-dial-tab td {
    padding: 5px;
  }
  </style>
</head>

<body>
  <div id=loadRecordings hidden><i class="fa fa-refresh fa-spin" style="font-size:16px;color:green"></i>  Loading Recordings</div>
  <div id=loadChannels hidden><i class="fa fa-refresh fa-spin" style="font-size:16px;color:green"></i>  Loading Channels</div>
  <div id=loadEPG hidden><i class="fa fa-refresh fa-spin" style="font-size:16px;color:green"></i>  Loading EPG</div>
<div id="tabs" class="">
    <ul>
      <li><a href="#tabs-1">EPG</a></li>
      <li><a href="#tabs-2">Recordings and Scheduled</a></li>
      <li><a href="#tabs-3">Series Recording Schedule</a></li>
    </ul>
 <div id="tabs-1">
  <table id="epgGrid"></table>
  <div id="epgMsg" hidden></div>
  <div id="epgGridPager"></div>
 </div>
 <div id="tabs-2">
  <table id="recordingsGrid"></table>
  <div id="recordingsMsg" hidden></div>
  <div id="recordingsGridPager"></div>
  <button id="recordingsExport" hidden>Print</button>
 </div>
 <div id="tabs-3">
  <table id="seriesGrid"></table>
  <div id="seriesMsg" hidden></div>
  <div id="seriesGridPager"></div>
  <button id="seriesExport" hidden>Print</button>
 </div>
</div>
  <div id="dialog-form" title="Schedule Recording" hidden>
    <table id="rec-dial-tab" border="1"  class="ui-widget">
      <tbody class="ui-widget-content">
      <tr><td>Title</td><td id="rectitle"/></tr>
      <tr><td>Channel</td><td id="recchan"/></tr>
      <tr><td>Description</td><td id="recdesc"/></tr>
      <tr><td>Start time</td><td id="recstart"/></tr>
      <tr><td>Stop time</td><td id="recstop"/></tr>
      <tr><td>Series CRID</td><td id="reccrid"/></tr>
      <tr hidden><td>Rowid</td><td id="recrow"/></tr>
      <tr><td>Recording&nbsp;Type</td><td id="rectyp">
        <input type='radio' id='single' name='rectype' value='1' checked='true' />
        <label for='single'>Single programme</label></br>
        <input type='radio' id='series' name='rectype' value='2' />
        <label for='series'>Series</label></br>
        <input type='radio' id='manual' name='rectype' value='3' />
        <label for='manual'>Periodic</label></br>
      </td></tr>
      </tbody>
    </table>
  </div>

  <script type="text/javascript">
    //jQuery.jgrid.no_legacy_api = true;
    $(document).ready(function() {
      $("#recordingsExport").hide();
      $("#seriesExport").hide();
      // set up tabs
      $( "#tabs" ).tabs();

      // set up modal dialog for recording schedule
      dialog = $( "#dialog-form" ).dialog({
        autoOpen: false,
        height: "auto",
        width: 600,
        modal: true,
        buttons: {
          "Schedule Recording": addRecord,
          Cancel: function() {
            dialog.dialog( "close" );
          }
        },
        close: function() {
          //form[ 0 ].reset();
          //allFields.removeClass( "ui-state-error" );
        }
      });

      //  Set grid defaults
      jQuery.extend(jQuery.jgrid.defaults, {
        altRows: true,
        responsive: true,
        autowidth: true,
        sortable: true,
        colMenu: true,
        headertitles: true,
        rowNum: 25,
        rowList: [10, 25, 50, 100, 150, 200, 250, 300],
        cmTemplate: {
          colmenu: true,
          editable: false,
          align: "center",
          editrules:{edithidden:true},
          viewable: true,
          searchoptions: {
            clearSearch: false,
            searchOperMenu: false,
            sopt: ['cn', 'eq', 'ne', 'lt', 'le', 'gt', 'ge', 'bw', 'bn', 'in', 'ni', 'ew', 'en', 'nc']
            }
          }
      });
      initRecordingsTable();
      initEPGTable();

      $("#loadChannels").show();
      // Load the Channels list
      $.ajax({
        url: urlPfx+"Method=GetXmltvChannelsList&FromChIndex=FirstChannel&ToChIndex=LastChannel&Externals=YES",
        success: function(ChannelList) {
          $("#loadChannels").hide();
          if (checkVboxResponse(ChannelList,'#loadChannels',"Load Channels")) {
             initChannelsTable(ChannelList);
             loadRecordings();
             loadEPG(fullEPG);
           }
        },
        error: function(xhr) {
          ajaxError(xhr,"#loadChannels","Error loading Channels");

          initChannelsTable(testChanList);
          recordList=testRecList;
          prepRecordingsTable();
          epgList=testEPGList;
          prepEPGTable();

        }
        });
      //end of doc ready function
    });

    function loadRecordings() {
        $("#loadRecordings").show();
        // Load the recordings list
        $.ajax({
          url: urlPfx+"Method=GetRecordsList&Externals=YES",
          success: function(recordings) {
            $("#loadRecordings").hide();
            if (checkVboxResponse(recordings,'#loadRecordings',"Load Recordings")) {
               recordList=recordings;
               prepRecordingsTable();
            }
          },
          error: function(xhr) {
            ajaxError(xhr,"#loadRecordings","Error loading Recordings");
          }

        });
      }

    function loadEPG(url) {
        $("#loadEPG").show();
        // Load the EPG list
        $.ajax({
          url: urlPfx+url,
          success: function(epgData) {
            $("#loadEPG").hide();
            if (checkVboxResponse(epgData,'#loadEPG',"Load EPG")) {
              epgList =epgData;
              prepEPGTable();
            }
          },
          error: function(xhr) {
            ajaxError(xhr,"#loadEPF","Error loading EPG");
          }
        });

    }

    function prepRecordingsTable() {

      // Create unique RowId, use negative for external recordings
      var extix = 0;
      var rec, recid, recids, i
      var records = recordList.getElementsByTagName("record");
      for (i = 0; i < records.length; i++) {
          rec = records[i];
          recids = rec.getElementsByTagName("record-id")
          if (recids.length == 1) {
            recid = rec.getElementsByTagName("record-id")[0].childNodes[0].nodeValue;
          } else  {
            recid = --extix;
          }
          // append RowId elemnent to record
          rowid = recordList.createElement("rowid");
          rowix = recordList.createTextNode("rec"+recid);
          rec.appendChild(rowid).appendChild(rowix);
          //
      }

      reloadRecordingsTable();
    }

    function reloadRecordingsTable() {
      $("#recordingsGrid").jqGrid("clearGridData")
                          .jqGrid('setGridParam', { datatype: "xmlstring", datastr: recordList })
                          .trigger('reloadGrid', [{ current:true}])
                          .jqGrid('sortGrid','start', true, 'desc');

      $("#seriesGrid").jqGrid("clearGridData")
                          .jqGrid('setGridParam', { datatype: "xmlstring", datastr: recordList })
                          .trigger('reloadGrid', [{ current:true}])
                          .jqGrid('sortGrid', 'current-start', true, 'desc');
    }

    function initRecordingsTable() {

      //  Recordings Grid
      var recColModel = colChan.concat(colRecChan,colTitle,colTime,colRec);
      $("#recordingsGrid").jqGrid({
          datatype: "xmlstring",
          datastr: recordList,
          colModel: recColModel,
          xmlReader: {
            root: "record-list",
            row: "record",
            repeatitems: false
          //  id: "record-id"
          },
          height: 'auto',
          loadonce: true,
          pager: '#recordingsGridPager',
          sortname: 'record-id',
          viewrecords: true,
          sortorder: "desc",
          caption: "Recordings"
        })
        .jqGrid('hideCol','channel-name')
        .jqGrid('filterToolbar',{searchOperators: true})
        .navGrid('#recordingsGridPager', {
          edit: false,
          add: false,
          del: false
        });
      $("#recordingsExport").on("click", function() {
        $("#recordingsGrid").jqGrid("exportToHtml", {
          includeLabels: true,
          includeGroupHeader: true,
          includeFooter: true,
          autoPrint: false
        });
      });

      // Series Grid
      var serColModel = colChan.concat(colTitle,colSer);
      $("#seriesGrid").jqGrid({
          datatype: "xmlstring",
          datastr: recordList,
          colModel: serColModel,
          xmlReader: {
            root: "record-list",
            row: "record-series",
            repeatitems: false
          },
          height: 'auto',
          loadonce: true,
          pager: '#seriesGridPager',
          sortname: 'current-start',
          viewrecords: true,
          sortorder: "desc",
          caption: "Series recording schedule"
        })
        .jqGrid('filterToolbar',{searchOperators: true})
        .navGrid('#seriesGridPager', {
          edit: false,
          add: false,
          del: false
        });
      $("#seriesExport").on("click", function() {
        $("#seriesGrid").jqGrid("exportToHtml", {
          includeLabels: true,
          includeGroupHeader: true,
          includeFooter: true,
          autoPrint: false
        });
      });
      // end Init recordings list
    }

    function initChannelsTable(ChannelList) {

      // Create arrays of channel name, icon
      var extix = 0;
      var chan, id, dname, name, lcn, type,  icon, url, i
      var chans = ChannelList.getElementsByTagName("channel");
      for (i = 0; i < chans.length; i++) {
          chan  = chans[i];
          id    = chan.getAttribute('id')
          dname = chan.getElementsByTagName("display-name");
          name  = dname[0].childNodes[0].nodeValue;
          type  = dname[1].childNodes[0].nodeValue;
          lcn   = dname[4].childNodes[0].nodeValue;
          icon  = chan.getElementsByTagName("icon")[0].getAttribute('src');
          url   = chan.getElementsByTagName("url")[0].getAttribute('src');
          // append  elemnent to arrays
          chanName[id] = name;
          chanType[id] = type;
          chanLCN[id] = lcn;
          chanIcon[id] = icon;
          chanURL[id] = url;

      }
      // end initChannelsTable
    }

    function prepEPGTable() {

      // Create unique RowId, epgnnnn
      var extix = 0;
      var rec, recid, recids, i
      var epgs = epgList.getElementsByTagName("programme");
      for (i = 0; i < epgs.length; i++) {
          rec = epgs[i];
          recid = ++extix;
          // append RowId elemnent to epg
          rowid = epgList.createElement("rowid");
          rowix = epgList.createTextNode("epg"+recid);
          rec.appendChild(rowid).appendChild(rowix);
          //
      }
      reloadEPGTable();
    }

    function reloadEPGTable() {

      $("#epgGrid").jqGrid("clearGridData")
                          .jqGrid('setGridParam', { datatype: "xmlstring", datastr: epgList })
                          .trigger('reloadGrid', [{ current:true}])
                          .jqGrid('sortGrid', 'start', true, 'asc');
    }

    function initEPGTable() {
      var epgColModel = colChan.concat(colEPGtitle,colTime,colEPG);
      //  epg Grid
      $("#epgGrid").jqGrid({
          datatype: "xmlstring",
          datastr: epgList,
          colModel: epgColModel,
          xmlReader: {
            root: "tv",
            row: "programme",
            repeatitems: false
          //  id: "epg-id"
          },
          height: 'auto',
          loadonce: true,
          pager: '#epgGridPager',
          sortname: 'epg-id',
          viewrecords: true,
          sortorder: "desc",
          caption: "EPG"
        })
        .jqGrid('filterToolbar',{searchOperators: true})
        .navGrid('#epgGridPager', {
          edit: false,
          add: false,
          del: false
        });

      // end EPG table init
    }

    /* checkVboxResponse
    check XML returned by vbox for non zero error ErrCode
    if found show in alert div and return false,
    return true if no error reported */
    function checkVboxResponse(vboxdat, divlabel, ident = "") {
      if (vboxdat.getElementsByTagName("ErrorCode").length==0) {return true}
      var ErrCode = vboxdat.getElementsByTagName("ErrorCode")[0].childNodes[0].nodeValue;
      if (ErrCode==0) {return true}
      var ErrDesc = vboxdat.getElementsByTagName("ErrorDescription")[0].childNodes[0].nodeValue;
      $(divlabel).html(alertIcon+" "+ident+" Vbox response: "+ ErrCode + " - " + ErrDesc ).show();
      alert(ident+" Vbox response: "+ ErrCode + " - " + ErrDesc );
      console.log(divlabel +" "+ ident+" Vbox response: "+ ErrCode + " - " + ErrDesc );
      return false;
    }

    function ajaxError(xhr, divlabel, ident = ""){
      $(divlabel).html(alertIcon+" "+ident+", code: "+ xhr.status + " - " + xhr.statusText ).show();
      console.log(divlabel+" "+ident+", code: "+ xhr.status + " - " + xhr.statusText)
    }

    /**
     * Format bytes as human-readable text.
     *
     * @param bytes Number of bytes.
     * @param si True to use metric (SI) units, aka powers of 1000. False to use
     *           binary (IEC), aka powers of 1024.
     * @param dp Number of decimal places to display.
     *
     * @return Formatted string.
     *
     * From:
     * https://stackoverflow.com/questions/10420352/converting-file-size-in-bytes-to-human-readable-string/10420404
     */
    function humanFileSize(bytes, si = false, dp = 1) {
      const thresh = si ? 1000 : 1024;

      if (Math.abs(bytes) < thresh) {
        return bytes + ' B';
      }

      const units = si ?
        ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'] :
        ['KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'];
      let u = -1;
      const r = 10 ** dp;

      do {
        bytes /= thresh;
        ++u;
      } while (Math.round(Math.abs(bytes) * r) / r >= thresh && u < units.length - 1);


      return bytes.toFixed(dp) + ' ' + units[u];
    }

    function setChanName(rowObject) {
      var cellvalue = $(rowObject).attr('channel');
      if (typeof cellvalue == 'undefined') {
        return "";
      }
      if (typeof chanName[cellvalue] == 'undefined') {
        return "";
      }
      return chanName[cellvalue];
    }

    function setChanURL(rowObject) {
      var cellvalue = $(rowObject).attr('channel');
      if (typeof cellvalue == 'undefined') {
        return "";
      }
      if (typeof chanURL[cellvalue] == 'undefined') {
        return "";
      }
      return chanURL[cellvalue];
    }

    function setChanType(rowObject) {
      var cellvalue = $(rowObject).attr('channel');
      if (typeof cellvalue == 'undefined') {
        return "";
      }
      if (typeof chanType[cellvalue] == 'undefined') {
        return "";
      }
      return chanType[cellvalue];
    }

    function setChanIcon(rowObject) {
      var cellvalue = $(rowObject).attr('channel');
      if (typeof cellvalue == 'undefined') {
        return "";
      }
      if (typeof chanIcon[cellvalue] == 'undefined') {
        return "";
      }
      var text = "<img src='"+chanIcon[cellvalue]+"' alt='"+chanName[cellvalue]+"' title='"+chanName[cellvalue]+"' width=16 height=16 >";
      return text;
    }

    function setChanLCN(rowObject) {
      var cellvalue = $(rowObject).attr('channel');
      if (typeof cellvalue == 'undefined') {
        return "";
      }
      if (typeof chanLCN[cellvalue] == 'undefined') {
        return "";
      }
      return chanLCN[cellvalue];
    }


    function fmtTimeStmp(cellvalue, options, rowObject) {
      //console.log("fmtTimeStmp " + cellvalue);
      if (typeof cellvalue == 'undefined') {
        return ""
      }
      if (cellvalue.length < 12) {
        return ""
      }
      var Yr = cellvalue.substr(0, 4);
      var Mon = cellvalue.substr(4, 2);
      var Day = cellvalue.substr(6, 2);
      var Hr = cellvalue.substr(8, 2);
      var Min = cellvalue.substr(10, 2);
      var Sec = cellvalue.substr(12, 2);
      var d = new Date(Yr, Mon - 1, Day, Hr, Min, Sec)
      var text = d.toLocaleString({
        dateStyle: 'short',
        timeStyle: 'short'
      });
      //console.log("fmtTimeStmp " + cellvalue +" "+text+" "+Yr+" "+Mon+" "+Day);
      return text;
    }

    function fmtTime(cellvalue, options, rowObject) {
      //console.log("fmtTimeStmp " + cellvalue);
      if (typeof cellvalue == 'undefined') {
        return ""
      }
      if (cellvalue.length < 12) {
        return ""
      }
      var Yr = cellvalue.substr(0, 4);
      var Mon = cellvalue.substr(4, 2);
      var Day = cellvalue.substr(6, 2);
      var Hr = cellvalue.substr(8, 2);
      var Min = cellvalue.substr(10, 2);
      var Sec = cellvalue.substr(12, 2);
      var d = new Date(Yr, Mon - 1, Day, Hr, Min, Sec)
      var text = d.toLocaleTimeString({
        dateStyle: 'short',
        timeStyle: 'short'
      });
      //console.log("fmtTimeStmp " + cellvalue +" "+text+" "+Yr+" "+Mon+" "+Day);
      return text;
    }

    function setDuration(rowObject) {
      //console.log("fmtTimeStmp " + cellvalue);
      if (typeof $(rowObject).attr('stop') == 'undefined') {
        return ""
      }
      if (typeof $(rowObject).attr('start') == 'undefined') {
        return ""
      }

      var stoptime = $(rowObject).attr('stop');
      var starttime = $(rowObject).attr('start');
      return calcDuration(starttime,stoptime);
    }

    function setDurationSeries(rowObject) {
      if (rowObject.getElementsByTagName("start").length == 0) {
        return ""
      }
      if (rowObject.getElementsByTagName("stop").length == 0) {
        return ""
      }

      var stoptime = rowObject.getElementsByTagName("stop")[0].childNodes[0].nodeValue;
      var starttime = rowObject.getElementsByTagName("start")[0].childNodes[0].nodeValue;
      return calcDuration(starttime,stoptime);
    }

    function calcDuration(starttime,stoptime) {
      var Yr  = stoptime.substr(0, 4);
      var Mon = stoptime.substr(4, 2);
      var Day = stoptime.substr(6, 2);
      var Hr  = stoptime.substr(8, 2);
      var Min = stoptime.substr(10, 2);
      var Sec = stoptime.substr(12, 2);
      var stop = new Date(Yr, Mon - 1, Day, Hr, Min, Sec);

      Yr  = starttime.substr(0, 4);
      Mon = starttime.substr(4, 2);
      Day = starttime.substr(6, 2);
      Hr  = starttime.substr(8, 2);
      Min = starttime.substr(10, 2);
      Sec = starttime.substr(12, 2);
      var start = new Date(Yr, Mon - 1, Day, Hr, Min, Sec);
      //var durn = new Date;
      var durn = new Date(stop -start).getTime();
      const hours = Math.floor(durn / 3600000);
      durn -= hours * 3600000;
      const minutes = Math.floor(durn / 60000);
      return `${hours}:${('0' + minutes).slice(-2)}`
    }

    function fmtDate(cellvalue, options, rowObject) {
      //console.log("fmtDate " + cellvalue);
      if (typeof cellvalue == 'undefined') {
        return ""
      }
      if (cellvalue.length < 8) {
        return ""
      }
      var Yr = cellvalue.substr(0, 4);
      var Mon = cellvalue.substr(4, 2);
      var Day = cellvalue.substr(6, 2);
      var Hr = 0;
      var Min = 0;
      var Sec = 0;
      var d = new Date(Yr, Mon - 1, Day, Hr, Min, Sec)
      var text = d.toLocaleDateString({
        dateStyle: 'short',
        timeStyle: 'short'
      });
      //console.log("fmtTimeStmp " + cellvalue +" "+text+" "+Yr+" "+Mon+" "+Day);
      return text;
    }

    function fmtSize(cellvalue, options, rowObject) {
      //console.log("fmtSize " + cellvalue);
      if (isNaN(cellvalue)) {
        return "";
      }
      var text = humanFileSize(cellvalue);
      //console.log(cellvalue + " = " + text)
      return text;
    }

    // Create a button for the Actions column
    function fmtButton(grid,id,funcName,label,icon,opts = {}){
      var text = '<div title="##label##" style="float:left;" class="ui-pg-div" id="##funcName##_##id##" \
          onclick=\'##funcName##(\"##grid##\","##id##","##label##",##opts##);\' \
          onmouseover="jQuery(this).addClass(\'ui-state-hover\');" \
          onmouseout="jQuery(this).removeClass(\'ui-state-hover\');"><span class="##icon##"></span></div>';
      text=text.replace(/##label##/g,label);
      text=text.replace(/##id##/g,id);
      text=text.replace(/##funcName##/g,funcName);
      text=text.replace(/##icon##/g,icon);
      text=text.replace(/##opts##/g,JSON.stringify(opts));
      text=text.replace(/##grid##/g,grid);

      //console.log("fmtButton = " + text)
      return text;
    }

    function setEPGactions(rowObject) {
      var rowid = rowObject.getElementsByTagName("rowid")[0].childNodes[0].nodeValue;

      var text =  "<div id='msg"+rowid+"' hidden width=150></div>";
      text +=  fmtButton("#epgGrid",rowid,'viewRow','View row details','fa fa-eye',{});
      var opts ={};
      text +=  fmtButton("#epgGrid",rowid,'schedRecord','Schedule Recording','fa fa-circle record-red',{});

      var state=$(rowObject).attr('state');
      switch (state) {
        case "scheduled":
          if (typeof $(rowObject).attr('series-id') != 'undefined') {
            // Can't delete series episode, must choose series table
            return text;
          }
        case "recording":
          opts.procurl = "Method=CancelRecord&RecordID="+rowid;
          break;
        case "recorded":
        case "Error":
          opts.procurl = "Method=DeleteRecord&RecordID="+rowid;
          break;
        case "External":
          opts.procurl = "Method=DeleteRecord&RecordID=External&FileName="+$(rowObject).attr('LocalTarget');
          break;
        default:
          return text;
      }
      text +=  fmtButton("#epgGrid",rowid,'procRecord','Delete recording','ui-icon ui-icon-trash',opts)

      //console.log(cellvalue + " = " + text)
      return text;
    }


    function setRecActions(rowObject) {
      var rowid = rowObject.getElementsByTagName("rowid")[0].childNodes[0].nodeValue;
      var state = rowObject.getElementsByTagName("state")[0].childNodes[0].nodeValue;
      if (state != "External") {
        var recid = rowObject.getElementsByTagName("record-id")[0].childNodes[0].nodeValue;
      }
      var text =  "<div id='msg"+rowid+"' hidden width=150></div>";
      text +=  fmtButton("#recordingsGrid",rowid,'viewRow','View row details','fa fa-eye',{});
      var opts ={};
      var butLabel="";
      switch (state) {
        case "scheduled":
          if (rowObject.getElementsByTagName("series-id").length != 0) {
            // Can't delete series episode, must choose series table
            return text;
          }
        case "recording":
          butLabel="Cancel recording";
          opts.procurl = "Method=CancelRecord&RecordID="+recid;
          break;
        case "recorded":
        case "Error":
          butLabel="Delete recording";
          opts.procurl = "Method=DeleteRecord&RecordID="+recid;
          break;
        case "External":
          butLabel="Delete external recording";
          opts.procurl = "Method=DeleteRecord&RecordID=External&FileName="+encodeURIComponent($(rowObject).attr('LocalTarget'));
          break;
        default:
          return text;
      }
      text +=  fmtButton("#recordingsGrid",rowid,'procRecord',butLabel,'ui-icon ui-icon-trash',opts)

      //console.log(cellvalue + " = " + text)
      return text;
    }

    function setSerActions(rowObject) {
      var serid =$(rowObject).attr('series-id');
      var rowid=serid;
      var opts = {};

      opts.procurl = "Method=CancelRecord&RecordID="+serid;
      var text =  "<div id='msg"+rowid+"' hidden width=50></div>";
      text +=  fmtButton("#seriesGrid",rowid,'viewRow','View row details','fa fa-eye',{});
      text +=  fmtButton("#seriesGrid",rowid,'procRecord','Cancel series recording','ui-icon ui-icon-trash',opts);

      //console.log(cellvalue + " = " + text)
      return text;
    }

    function viewRow(grid, rowid, label, opts ={}) {
       $(grid).jqGrid('viewGridRow',rowid,{modal:true,closeOnEscape:true,viewhidden:true});
    };

    function schedRecord(grid, rowid, label, opts ={}) {
       var rowObj =$(grid).jqGrid('getRowData',rowid);
       var chan = rowObj["channel-LCN"] + " " + rowObj["channel-icon"] + " " + rowObj["channel-name"] ;
       $("#recchan").html(chan);
       $("#rectitle").html(rowObj["title"]);
       $("#recdesc").html(rowObj["desc"]);
       $("#recstart").html(rowObj["start"]);
       $("#recstop").html(rowObj["stop"]);
       $("#recrow").html(rowObj["rowid"]);
       $("#reccrid").html(rowObj["crid"]);
       $("#single").prop('checked', true).trigger('change');
       if (rowObj["crid"]== "") {
         $("#series").prop('disabled', true);
       } else {
         $("#series").prop('disabled', false);
       }

       dialog.dialog( "open" );
    };

    function addRecord(grid, rowid, label, opts ={}) {
       //$(grid).jqGrid('viewGridRow',rowid,{modal:true,closeOnEscape:true,viewhidden:true});
       var rowid = $("#recrow").html();
       var rowObj =$("#epgGrid").jqGrid('getRowData',rowid);
       var chanid = rowObj["channel-id"];
       var title = encodeURIComponent(rowObj["title"]);
       var vbstart = encodeURIComponent(rowObj["vbstart"]);
       //var vbstart = fmtVboxDate(start);
       var opts= {}, label = "";
       if ($("#single").prop("checked")){
            opts.procurl = "Method=ScheduleProgramRecord&ChannelID="+chanid+"&ProgramTitle="+title+"&StartTime="+vbstart+"";
            label= "record single programme";
        } if ($("#series").prop("checked")){
          opts.procurl = "Method=ScheduleProgramRecord&ChannelID="+chanid+"&ProgramTitle="+title+"&StartTime="+vbstart+"&SeriesRecording=YES";
          label= "schedule series recording"
        } if ($("#manual").prop("checked")){
          alert ("Periodic not yet available");
          return;
        }

       dialog.dialog( "close" );

       procRecord("#epgGrid",rowid,label,opts)
    };

    function procRecord(grid, id, label, opts ={}) {
      console.log("procRecord " + label + " " + id + ", "+grid +", "+ JSON.stringify(opts));
      var procurl = opts.procurl
      var ident = "Error " + label;
      $.ajax({
        url: urlPfx+procurl,
        success: function(response) {
          if (checkVboxResponse(response,"#msg"+id,ident)) {
             // Reload recordings
             loadRecordings();
          }
        },
        error: function(xhr) {
          ajaxError(xhr,"#msg"+id,ident);
          alert(ident+", code: "+ xhr.status + " - " + xhr.statusText );
        }
      });
    }

    function fmtVboxDate(date) {
      var dt = new Date(date);
      var vbdt = dt.getFullYear();
      return vbdt;
    }

    // Icons
    var alertIcon = '<i class="fa fa-exclamation-triangle" style="font-size:16px;color:red"></i>';
    var loadIcon = '<i class="fa fa-refresh fa-spin" style="font-size:16px;color:green"></i>';

    // define variable to hold recordings, epg, and channel data
    var recordList;
    var epgList;

    var chanName = [];
    var chanIcon = [];
    var chanLCN = [];
    var chanURL = [];
    var chanType = [];

    // ColModel definitions for Channel related columns
    var colChan = [
      {
        label: 'Channel Id',
        name: 'channel-id',
        tooltip: 'Vbox channel identifier',
        hidden: true,
        width: 120,
        xmlmap: '[channel]'
      },
      {
        label: 'Icon',
        name: 'channel-icon',
        tooltip: 'Channel icon, derived from channel-id',
        width: 30,
        sortable: false,
        colmenu: false,
        search:false,
        xmlmap: setChanIcon,
        //xmlmap: '[channel]'
      },
      {
        label: 'Channel Name',
        name: 'channel-name',
        tooltip: 'Channel name, derived from channel-id',
        width: 120,
        xmlmap: setChanName,
        //xmlmap: '[channel]'
      },
      {
        label: 'LCN',
        name: 'channel-LCN',
        tooltip: 'Local channel number, derived from channel-id',
        width: 60,
        sorttype: "number",
        formatter: 'integer',
        hidden: true,
        xmlmap: setChanLCN,
        //xmlmap: '[channel]'
      },
      {
        label: 'Type',
        name: 'channel-Type',
        tooltip: 'Channel type, derived from channel-id',
        width: 60,
        hidden: true,
        xmlmap: setChanType,
        //xmlmap: '[channel]'
      },
      {
        label: 'Channel URL',
        name: 'channel-URL',
        tooltip: 'URL for channel, derived from channel-id',
        width: 120,
        hidden: true,
        xmlmap: setChanURL,
        //xmlmap: '[channel]'
      }
    ];

    // ColModel definitions for Start/Stop?duration columns
    var colTime=[
      {
        label: 'VB Start',
        name: 'vbstart',
        tooltip: 'Programme start date and time (vbox format)',
        width: 140,
        hidden: true,
        xmlmap: '[start]'
      },
      {
        label: 'Start',
        name: 'start',
        tooltip: 'Programme start date and time',
        width: 105,
        hidden: true,
        formatter: fmtTimeStmp,
        xmlmap: '[start]'
      },
      {
        label: 'Start Date',
        name: 'start-date',
        tooltip: 'Programme start date',
        width: 90,
        formatter: fmtDate,
        xmlmap: function(obj) {
          return $(obj).attr('start').substr(0, 8);
        }
      },
      {
        label: 'Start Time',
        name: 'start-time',
        tooltip: 'Programme start time',
        width: 90,
        formatter: fmtTime,
        xmlmap: '[start]'
      },
      {
        label: 'VB Stop',
        name: 'vbstop',
        tooltip: 'Programme stop date and time (vbox format)',
        width: 140,
        hidden: true,
        xmlmap: '[stop]'
      },
      {
        label: 'Stop',
        name: 'stop',
        tooltip: 'Programme end date and time',
        width: 105,
        hidden: true,
        formatter: fmtTimeStmp,
        xmlmap: '[stop]'
      },
      {
        label: 'Stop Date',
        name: 'stop-date',
        tooltip: 'Programme end date',
        width: 90,
        hidden: true,
        formatter: fmtDate,
        xmlmap: function(obj) {
          return $(obj).attr('stop').substr(0, 8);
        }
      },
      {
        label: 'Stop Time',
        name: 'stop-time',
        tooltip: 'Programme end time',
        width: 90,
        hidden: true,
        formatter: fmtTime,
        xmlmap: '[stop]'
      },
      {
        label: 'Len',
        tooltip: 'Programme length (stop - start)',
        name: 'duration',
        width: 50,
        sorttype: "number",
        xmlmap: setDuration,
        //xmlmap: '[stop]-[start]'
    }];

    // ColModel definitions for Title and Description columns
    var colTitle =[
      {
        label: 'Title',
        name: 'title',
        width: 200,
        xmlmap: 'programme-title'
      },
      {
        label: 'Description',
        name: 'desc',
        width: 200,
        xmlmap: 'programme-desc'
      },
    ];
    var colEPGtitle = [{
        label: 'Title',
        name: 'title',
        width: 200,
        xmlmap: 'title'
      },
      {
        label: 'Description',
        name: 'desc',
        width: 200,
        xmlmap: 'desc'
      }];

    // ColModel definitions specific to EPG grid
    var colEPG = [
      {
        label: 'PG',
        name: 'rating',
        tooltip: 'Parental guidance rating',
        width: 50,
        xmlmap: 'rating value'
      },
      {
        label: 'Series CRID',
        name: 'crid',
        tooltip: 'EPG series identifier',
        width: 100,
        xmlmap: 'episode-num'
      },
      {
        label: 'Ser Id',
        name: 'series-id',
        tooltip: 'Vbox series identifier',
        width: 65,
        sorttype: "number",
        formatter: 'integer',
        formatoptions: {
          thousandsSeparator: "",
          defaultValue: ""
        },
        align: 'right',
        xmlmap: 'series-id'
      },
      {
        label: 'Rec Id',
        name: 'record-id',
        tooltip: 'Vbox recording identifier',
        width: 65,
        key: false,
        sorttype: "number",
        formatter: 'integer',
        formatoptions: {
          thousandsSeparator: "",
          defaultValue: ""
        },
        align: 'right',
        xmlmap: 'record-id'
        },
      {
        label: 'RowId',
        name: 'rowid',
        tooltip: 'webif unique row identifier',
        width: 70,
        key: true,
        hidden: true,
        xmlmap: 'rowid'
      },
      {
        label: "Actions",
        name: "actions",
        colmenu: false,
        width: 60,
        search:false,
        xmlmap: setEPGactions,
      }
    ];

    // ColModel definitions specific to Recordings grid
    var colRecChan=[
      {
        label: 'Channel-Name',
        name: 'chanName',
        tooltip: 'Recording Channel name',
        width: 120,
        xmlmap: 'channel-name'
      }];
    var colRec =[      {
        label: 'State',
        name: 'state',
        tooltip: 'Recording state',
        width: 100,
        stype: 'select',
        searchoptions:
          {value: {'':'',
                   recorded: 'Recorded',
                   recording: 'Recording',
                   scheduled: 'Scheduled',
                   External: 'External',
                   Error: 'Error'
                 }},
        xmlmap: 'state'
      },
      {
        label: 'Error desc',
        name: 'error-description',
        tooltip: 'Error description (if State=Error)',
        width: 150,
        xmlmap: 'error-description'
      },
      {
        label: 'Ser Id',
        name: 'series-id',
        tooltip: 'Vbox series identifier',
        width: 65,
        sorttype: "number",
        formatter: 'integer',
        formatoptions: {
          thousandsSeparator: "",
          defaultValue: ""
        },
        align: 'right',
        xmlmap: 'series-id'
      },
      {
        label: 'Rec Id',
        name: 'record-id',
        tooltip: 'Vbox recording identifier',
        width: 65,
        key: false,
        sorttype: "number",
        formatter: 'integer',
        formatoptions: {
          thousandsSeparator: "",
          defaultValue: ""
        },
        align: 'right',
        xmlmap: 'record-id'
      },
      {
          label: 'RowId',
          name: 'rowid',
          tooltip: 'webif unique row identifier',
          width: 65,
          key: true,
          hidden: true,
          xmlmap: 'rowid'
      },
      {
        label: 'Size',
        name: 'filesize',
        tooltip: 'Recorded file size',
        width: 85,
        sorttype: "number",
        formatter: fmtSize,
        formatoptions: {
          defaultValue: ""
        },
        align: 'right',
        xmlmap: 'fileSize'
      },
      {
        label: 'Record URL',
        name: 'url',
        tooltip: 'Recording URL',
        hidden: true,
        width: 100,
        xmlmap: 'url'
      },
      {
        label: 'File Name',
        name: 'LocalTarget',
        tooltip: 'Recording file name and location',
        hidden: true,
        width: 100,
        xmlmap: 'LocalTarget'
      },
      {
        label: "Actions",
        name: "actions",
        colmenu: false,
        width: 60,
        search:false,
        xmlmap: setRecActions,
      }
    ];

    // ColModel definitions specific to Series grid
    var colSer =[
      {
        label: 'Current',
        name: 'current-start',
        tooltip: 'Next (or Last) episode start date and time',
        width: 105,
        hidden: true,
        formatter: fmtTimeStmp,
        xmlmap: 'current-start'
      },
      {
        label: 'Curr Date',
        name: 'current-date',
        tooltip: 'Next (or Last) episode start date',
        width: 90,
        formatter: fmtDate,
        xmlmap: function(obj) {
          return obj.getElementsByTagName("current-start")[0].childNodes[0].nodeValue.substr(0, 8);
        }
      },
      {
        label: 'Curr Time',
        name: 'current-time',
        tooltip: 'Next (or Last) episode start time',
        width: 90,
        formatter: fmtTime,
        xmlmap: 'current-start'
      },
      {
        label: 'Rec Days',
        name: 'days-in-week',
        tooltip: 'Periodic recording Days of week (0=Sunday, 1=Monday ... 6=Saturday)',
        width: 90,
        xmlmap: 'days-in-week'
      },
      {
        label: 'Start Time',
        name: 'start',
        tooltip: 'Periodic recording Start time',
        width: 90,
        formatter: fmtTime,
        xmlmap: 'start'
      },
      {
        label: 'Stop time',
        name: 'stop',
        tooltip: 'Periodic recording Stop time',
        width: 90,
        formatter: fmtTime,
        xmlmap: 'stop'
      },
      {
        label: 'Len',
        name: 'duration',
        tooltip: 'Periodic recording Recording length (stop-start)',
        width: 50,
        xmlmap: setDurationSeries,
        //xmlmap: '[stop]-[start]'
      },
      {
        label: 'Match',
        name: 'match-tile',
        tooltip: 'Try to match programme title from time',
        width: 50,
        xmlmap: 'try-To-Match-Program-Title-From-Time',
      },
      {
        label: 'Series CRID',
        name: 'crid',
        tooltip: 'EPG series identifier',
        width: 100,
        xmlmap: 'crid'
      },
      {
        label: 'Ser Id',
        name: 'series-id',
        tooltip: 'Vbox series identifier',
        width: 65,
        key: true,
        sorttype: "number",
        formatter: 'integer',
        formatoptions: {
          thousandsSeparator: "",
          defaultValue: ""
        },
        align: 'right',
        xmlmap: function(obj) {
          return $(obj).attr('series-id');
        }
      },
      {
        label: 'Rec Id',
        name: 'record-id',
        tooltip: 'Vbox recording identifier',
        width: 65,
        sorttype: "number",
        formatter: 'integer',
        formatoptions: {
          thousandsSeparator: "",
          defaultValue: ""
        },
        align: 'right',
        xmlmap: 'schedule-record-id'
      },
      {
        label: 'Lang',
        name: 'lang',
        hidden: true,
        width: 65,
        xmlmap: 'lang'
      },
      {
        label: "Actions",
        name: "actions",
        width: 60,
        search:false,
        colmenu: false,
        xmlmap: setSerActions
      }
    ];

    const urlPfx="../cgi-bin/HttpControl/HttpControlApp?OPTION=1&";
    const BBC12="Method=GetXmltvSection&FromChIndex=1&ToChIndex=2"
    const fullEPG="Method=GetXmltvEntireFile&FilterBy=TVOnly";

    // Test data
    var parser = new DOMParser();
    var testRecList = parser.parseFromString('<?xml version="1.0" encoding="utf-8"?>\
    <record-list>\
      <record channel="www.Sky%20Arts.co.un" start="20201229190000 +0000" stop="20201229200000 +0000">\
        <channel-name>Sky Arts</channel-name>\
        <programme-title lang="eng">Queen: Live At Milton Keynes</programme-title>\
        <programme-desc lang="eng">A captivating Freddie Mercury leads Queen in this 1982 concert, filmed live at the National Bowl in Milton Keynes. The band perform a rousing set featuring Flash and Under Pressure. [S]</programme-desc>\
        <record-id>1323</record-id>\
        <state>recorded</state>\
        <url>http://127.0.0.1:55555/NetworkMedia/Queen%2D%20Live%20At%20Milton%20Keynes__Sky%20Arts__29%2D12%2D2020_19%2D00.mpg</url>\
        <LocalTarget>/usr/local/bin/vboxUpnp/shared/NetworkMedia/Queen- Live At Milton Keynes__Sky Arts__29-12-2020_19-00.mpg</LocalTarget>\
        <fileSize>674701544</fileSize>\
      </record>\
      <record-series channel="www.BBC%20ONE%20South.co.un" series-id="19081">\
        <schedule-record-id>33608</schedule-record-id>\
        <current-start>20210614010000 +0100</current-start>\
        <days-in-week>2</days-in-week>\
        <start>20210524010000 +0100</start>\
        <stop>20210524022000 +0100</stop>\
        <try-To-Match-Program-Title-From-Time>1</try-To-Match-Program-Title-From-Time>\
      </record-series>\
    </record-list>',"text/xml");
    var testEPGList = parser.parseFromString('﻿<?xml version="1.0" encoding="utf-8"?>\
    <!DOCTYPE tv SYSTEM "xmltv.dtd">\
    <tv generator-info-url="www.vboxcomm.com" generator-info-name="vbox">\
    	<channel id="www.BBC%20ONE%20South.co.un">\
    		<display-name>BBC ONE South</display-name>\
    		<display-name>TV</display-name>\
    		<display-name>T-GBR-233a10431043</display-name>\
    		<display-name>Free</display-name>\
    		<display-name>1</display-name>\
    		<icon src="http://vbox:55555/images/tv_icon.jpg"/>\
    		<url src="http://vbox:55555/BBC%20ONE%20South"/>\
    	</channel>\
    	<channel id="www.BBC%20TWO.co.un">\
    		<display-name>BBC TWO</display-name>\
    		<display-name>TV</display-name>\
    		<display-name>T-GBR-233a104310bf</display-name>\
    		<display-name>Free</display-name>\
    		<display-name>2</display-name>\
    		<icon src="http://vbox:55555/images/tv_icon.jpg"/>\
    		<url src="http://vbox:55555/BBC%20TWO"/>\
    	</channel>\
    	<programme start="20210619175500 +0100" stop="20210619184500 +0100" channel="www.BBC%20ONE%20South.co.un">\
    		<title lang="eng">Pointless Celebrities</title>\
    		<desc lang="eng">A comedians edition featuring Sofie Hagen, Jenny Eclair, Cariad Lloyd, Darren Harriott, Nish Kumar, Ed Gamble, Simon Evans and Geoff Norcott. Also in HD. [S]</desc>\
    		<episode-num system="dd_progid">/b-NNCP0</episode-num>\
        <rating system="VBOX">\
          <value>3</value>\
        </rating>\
    	</programme>\
    	<programme start="20210619173000 +0100" stop="20210619183000 +0100" channel="www.BBC%20TWO.co.un">\
    		<title lang="eng">The Great Northern Garden Build</title>\
    		<desc lang="eng">With the major construction work well underway, what impact will the pandemic have? Also in HD. [S]</desc>\
    		<episode-num system="dd_progid">/m-H9JZ/1</episode-num>\
        <rating system="VBOX">\
          <value>3</value>\
        </rating>\
    	</programme>\
    </tv>',"text/xml");
    var testChanList = parser.parseFromString('﻿<?xml version="1.0" encoding="utf-8"?>\
    <!DOCTYPE tv SYSTEM "xmltv.dtd">\
    <tv generator-info-url="www.vboxcomm.com" generator-info-name="vbox">\
    	<channel id="www.BBC%20ONE%20South.co.un">\
    		<display-name>BBC ONE South</display-name>\
    		<display-name>TV</display-name>\
    		<display-name>T-GBR-233a10431043</display-name>\
    		<display-name>Free</display-name>\
    		<display-name>1</display-name>\
    		<icon src="http://vbox:55555/images/tv_icon.jpg"/>\
    		<url src="http://vbox:55555/BBC%20ONE%20South"/>\
    	</channel>\
    	<channel id="www.BBC%20TWO.co.un">\
    		<display-name>BBC TWO</display-name>\
    		<display-name>TV</display-name>\
    		<display-name>T-GBR-233a104310bf</display-name>\
    		<display-name>Free</display-name>\
    		<display-name>2</display-name>\
    		<icon src="http://vbox:55555/images/tv_icon.jpg"/>\
    		<url src="http://vbox:55555/BBC%20TWO"/>\
    	</channel>\
    </tv>',"text/xml");

  </script>

</body>

</html>
